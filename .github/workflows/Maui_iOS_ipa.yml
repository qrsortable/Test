name: MAUI iOS IPA Build (Sideloadly Compatible)
on:
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.100'
  PROJECT_PATH: 'MyMauiAppIos'
  TARGET_FRAMEWORK: 'net9.0-ios'
  CONFIGURATION: 'Release'

jobs:
  build-ios:
    name: ðŸŽ Build iOS IPA for Sideloadly
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      # ============================================
      # STEP 1: Checkout Repository
      # ============================================
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ============================================
      # STEP 2: Setup Xcode (Crucial for .NET 9)
      # ============================================
      - name: âš™ï¸ Set Xcode version
        run: |
          # Selecting 16.1 or 16.0 which are compatible with .NET 9
          if [ -d "/Applications/Xcode_16.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.1.app
          else
            sudo xcode-select -s /Applications/Xcode_16.app
          fi
          xcodebuild -version

      # ============================================
      # STEP 3: Setup .NET
      # ============================================
      - name: ðŸ”· Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      # ============================================
      # STEP 4: Cache NuGet Packages
      # ============================================
      - name: ðŸ’¾ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/Library/Caches/NuGet
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # ============================================
      # STEP 5: Create Entitlements.plist
      # ============================================
      - name: ðŸ“ Create Entitlements.plist
        run: |
          mkdir -p ${{ env.PROJECT_PATH }}/Platforms/iOS
          cat > ${{ env.PROJECT_PATH }}/Platforms/iOS/Entitlements.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>keychain-access-groups</key>
              <array>
                  <string>$(AppIdentifierPrefix)com.companyname.mymauiappios</string>
              </array>
              <key>get-task-allow</key>
              <true/>
              <key>com.apple.security.network.client</key>
              <true/>
          </dict>
          </plist>
          EOF

      # ============================================
      # STEP 6: Install MAUI Workloads
      # ============================================
      - name: ðŸ“¦ Install MAUI workloads
        run: |
          # Only install iOS to save time; -p:TargetFrameworks later handles the rest
          dotnet workload install maui-ios
      
      # ============================================
      # STEP 7: Find Project File
      # ============================================
      - name: ðŸ” Find .csproj file
        id: find_csproj
        run: |
          CSPROJ_FILE=$(find ${{ env.PROJECT_PATH }} -maxdepth 1 -name "*.csproj" | head -n 1)
          CSPROJ_NAME=$(basename "$CSPROJ_FILE")
          APP_NAME="${CSPROJ_NAME%.csproj}"
          echo "csproj_name=$CSPROJ_NAME" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      # ============================================
      # STEP 8: Restore NuGet Packages
      # ============================================
      - name: ðŸ“¥ Restore NuGet packages (iOS only)
        run: |
          # Override TargetFrameworks here to avoid Android workload requirement
          dotnet restore ${{ steps.find_csproj.outputs.csproj_name }} \
