name: MAUI iOS Unsigned IPA for Sideloadly

on:
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'MyMauiAppIos'
  TARGET_FRAMEWORK: 'net9.0-ios'
  CONFIGURATION: 'Release'

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          if [ -d "/Applications/Xcode_15.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.2.app
          else
            echo "Using default Xcode"
          fi
          xcode-select -p
          xcodebuild -version

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore workloads
        run: |
          cd ${{ env.PROJECT_PATH }}
          dotnet workload restore
          dotnet workload install maui-ios

      - name: Restore NuGet
        run: dotnet restore MyMauiAppIos.csproj
        working-directory: ${{ env.PROJECT_PATH }}

      - name: Publish unsigned IPA
        run: |
          dotnet publish MyMauiAppIos.csproj \
            -f ${{ env.TARGET_FRAMEWORK }} \
            -c ${{ env.CONFIGURATION }} \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:BuildIpa=true \
            -p:EnableCodeSigning=false \
            -p:MtouchLink=None \
            -p:MtouchNoFastDev=true \
            -p:UseInterpreter=false \
            -p:SupportedOSPlatformVersion=16.0 \
            -p:TargetPlatformMinVersion=16.0
        working-directory: ${{ env.PROJECT_PATH }}

      - name: Find IPA
        id: find_ipa
        run: |
          IPA_FILE=$(find ${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }} -type f -name "*.ipa" | head -n 1)
          if [ -z "$IPA_FILE" ]; then
            echo "No IPA found"
            exit 1
          fi
          echo "ipa_path=$IPA_FILE" >> "$GITHUB_OUTPUT"
          echo "Found IPA at: $IPA_FILE"

      - name: Copy IPA
        run: |
          cp "${{ steps.find_ipa.outputs.ipa_path }}" "${{ github.workspace }}/MyMauiAppIos-Unsigned.ipa"
          ls -lh "${{ github.workspace }}/MyMauiAppIos-Unsigned.ipa"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyMauiAppIos-Unsigned
          path: MyMauiAppIos-Unsigned.ipa
          if-no-files-found: error
