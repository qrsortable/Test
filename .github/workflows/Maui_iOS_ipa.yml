name: MAUI iOS IPA Build

on:
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.100'
  PROJECT_PATH: 'MyMauiAppIos'
  TARGET_FRAMEWORK: 'net9.0-ios'
  CONFIGURATION: 'Release'

jobs:
  build-ios:
    runs-on: macos-14  # Use macos-14 for better Xcode compatibility
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîç List Available Xcode Versions
        run: |
          echo "Available Xcode versions:"
          ls -la /Applications/ | grep Xcode
      
      - name: ‚öôÔ∏è Set Xcode version
        run: |
          # Use Xcode 16.1 or latest stable
          if [ -d "/Applications/Xcode_16.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.1.app
          else
            echo "Using default Xcode"
          fi
          
          echo "Selected Xcode:"
          xcode-select -p
          xcrun --sdk iphoneos --show-sdk-version
      
      - name: üî∑ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: üîç Fix MAUI Version and Patch Project
        id: find_csproj
        run: |
          CSPROJ_FILE=$(find ${{ env.PROJECT_PATH }} -maxdepth 1 -name "*.csproj" | head -n 1)
          CSPROJ_NAME=$(basename "$CSPROJ_FILE")
          echo "csproj_name=$CSPROJ_NAME" >> $GITHUB_OUTPUT
          FULL_PATH="${{ env.PROJECT_PATH }}/$CSPROJ_NAME"
          
          # 1. Fix MAUI Version (CRITICAL FIX)
          sed -i '' 's|<MauiVersion>9.0.40</MauiVersion>|<MauiVersion>9.0.10</MauiVersion>|g' "$FULL_PATH"
          
          # 2. Force single target
          sed -i '' 's|<TargetFrameworks>.*</TargetFrameworks>|<TargetFrameworks>net9.0-ios</TargetFrameworks>|g' "$FULL_PATH"
          
          # 3. Inject Bypass Properties
          sed -i '' '/<PropertyGroup>/a \
          <MtouchLink>None</MtouchLink>\
          <MtouchUseRegistrar>Static</MtouchUseRegistrar>\
          <MtouchExtraArgs>--ignore-xcode-version</MtouchExtraArgs>\
          <ValidateXcodeVersion>false</ValidateXcodeVersion>\
          <MauiSkipResizetize>true</MauiSkipResizetize>' "$FULL_PATH"
          
          # 4. Fix Info.plist copy warning
          sed -i '' 's|None Include="Platforms\\iOS\\Info.plist"|BundleResource Include="Platforms\\iOS\\Info.plist" Link="Info.plist"|g' "$FULL_PATH"
          
          echo "‚úÖ Project file patched"
      
      - name: üì¶ Install MAUI workloads
        run: dotnet workload install maui-ios
      
      - name: üì• Restore
        run: dotnet restore ${{ steps.find_csproj.outputs.csproj_name }} -p:TargetFrameworks=net9.0-ios
        working-directory: ${{ env.PROJECT_PATH }}
      
      - name: üî® Build and Publish
        run: |
          IOS_SDK_VERSION=$(xcrun --sdk iphoneos --show-sdk-version)
          echo "Using iOS SDK version: $IOS_SDK_VERSION"
          
          dotnet publish ${{ steps.find_csproj.outputs.csproj_name }} \
            -f:net9.0-ios \
            -c:Release \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:BuildIpa=true \
            -p:ArchiveOnBuild=true \
            -p:EnableCodeSigning=false \
            -p:PublishTrimmed=true \
            -p:TrimMode=partial \
            -p:MtouchLink=None \
            -p:MauiSkipResizetize=true \
            --verbosity normal
        working-directory: ${{ env.PROJECT_PATH }}
      
      - name: üì¶ Final Packaging
        if: success()
        run: |
          BUILD_PATH="${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}/ios-arm64"
          
          PUBLISH_DIR=$(find "$BUILD_PATH" -type d -name "publish" | head -n 1)
          if [ -z "$PUBLISH_DIR" ]; then
            PUBLISH_DIR="$BUILD_PATH"
          fi
          
          APP_FOLDER=$(find "$PUBLISH_DIR" -name "*.app" -type d | head -n 1)
          
          if [ -z "$APP_FOLDER" ]; then
            echo "‚ùå Error: No .app folder found"
            exit 1
          fi
          
          echo "‚úÖ Found app: $APP_FOLDER"
          
          APP_NAME=$(basename "${APP_FOLDER%.app}")
          chmod +x "$APP_FOLDER/$APP_NAME"
          
          IPA_DIR="$BUILD_PATH/ipa-build"
          mkdir -p "$IPA_DIR/Payload"
          cp -R "$APP_FOLDER" "$IPA_DIR/Payload/"
          
          cd "$IPA_DIR"
          zip -qry "Sideload-Ready.ipa" Payload
          mv "Sideload-Ready.ipa" "$BUILD_PATH/"
          
          echo "‚úÖ IPA created successfully"
          ls -lh "$BUILD_PATH/Sideload-Ready.ipa"
      
      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: Maui-iOS-App
          path: ${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}/ios-arm64/Sideload-Ready.ipa
