name: MAUI iOS IPA Build
on:
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.100'
  PROJECT_PATH: 'MyMauiAppIos'
  TARGET_FRAMEWORK: 'net9.0-ios'
  CONFIGURATION: 'Release'

jobs:
  build-ios:
    name: ðŸŽ Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Set Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_16.1.app
          xcodebuild -version

      - name: ðŸ”· Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: ðŸ” Find and Patch Project
        id: find_csproj
        run: |
          CSPROJ_FILE=$(find ${{ env.PROJECT_PATH }} -maxdepth 1 -name "*.csproj" | head -n 1)
          CSPROJ_NAME=$(basename "$CSPROJ_FILE")
          echo "csproj_name=$CSPROJ_NAME" >> $GITHUB_OUTPUT
          FULL_PATH="${{ env.PROJECT_PATH }}/$CSPROJ_NAME"

          # 1. Strip MauiIcon/Splash to bypass simulator/resizetizer errors
          sed -i '' '/<MauiIcon/d' "$FULL_PATH"
          sed -i '' '/<MauiSplashScreen/d' "$FULL_PATH"

          # 2. FORCE ONLY iOS (Fixes NETSDK1147 Android Workload error)
          sed -i '' 's|<TargetFrameworks>.*</TargetFrameworks>|<TargetFrameworks>net9.0-ios</TargetFrameworks>|g' "$FULL_PATH"

          # 3. Inject Compatibility Properties (Fixes MT4162 UIKit error)
          sed -i '' '/<PropertyGroup>/a \
          <ValidateXcodeVersion>false</ValidateXcodeVersion>\
          <SkipValidateXcodeVersion>true</SkipValidateXcodeVersion>\
          <MtouchTargetSdk>18.0</MtouchTargetSdk>\
          <MtouchLink>SdkOnly</MtouchLink>\
          <MtouchUseRegistrar>Static</MtouchUseRegistrar>\
          <MauiSkipResizetize>true</MauiSkipResizetize>' "$FULL_PATH"
          
          # 4. Fix Info.plist metadata warning
          sed -i '' 's|None Include="Platforms\\iOS\\Info.plist"|BundleResource Include="Platforms\\iOS\\Info.plist" Link="Info.plist"|g' "$FULL_PATH"
          
          echo "âœ… Applied patches to $CSPROJ_NAME"

      - name: ðŸ“¦ Install MAUI workloads
        run: dotnet workload install maui-ios
      
      - name: ðŸ“¥ Restore NuGet packages
        run: |
          dotnet restore ${{ steps.find_csproj.outputs.csproj_name }} \
            -p:TargetFrameworks=net9.0-ios
        working-directory: ${{ env.PROJECT_PATH }}

      - name: ðŸ”¨ Build and Publish iOS app
        run: |
          # Quiet verbosity is used to prevent GitHub log buffer freezes
          dotnet publish ${{ steps.find_csproj.outputs.csproj_name }} \
            -f:net9.0-ios \
            -c:Release \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:BuildIpa=true \
            -p:ArchiveOnBuild=true \
            -p:EnableCodeSigning=false \
            -p:MtouchExtraArgs="--ignore-xcode-version" \
            --verbosity quiet
        working-directory: ${{ env.PROJECT_PATH }}
        env:
          MD_APPLE_SDK_ROOT: /Applications/Xcode_16.1.app

      - name: ðŸ“¦ Final Packaging for Sideloadly
        if: success()
        run: |
          BUILD_PATH="${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}/ios-arm64"
          APP_FOLDER=$(find "$BUILD_PATH" -name "*.app" -type d | head -n 1)
          
          # Force binary executable permissions (CRITICAL for sideloading)
          EXEC_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$APP_FOLDER/Info.plist")
          chmod +x "$APP_FOLDER/$EXEC_NAME"
          
          # Manually package into IPA
          mkdir -p "$BUILD_PATH/Payload"
          cp -R "$APP_FOLDER" "$BUILD_PATH/Payload/"
          cd "$BUILD_PATH"
          zip -qry "MyMauiApp-Sideload.ipa" Payload
          
          echo "âœ… IPA created: $BUILD_PATH/MyMauiApp-Sideload.ipa"

      - name: ðŸ“¤ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Maui-iOS-Sideload-IPA
          path: ${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}/ios-arm64/*.ipa
