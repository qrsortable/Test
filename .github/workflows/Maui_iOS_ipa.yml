name: Build iOS IPA (.NET 9, iOS 16+, Sideloadly)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Show Xcode info
      run: |
        xcodebuild -version
        xcode-select -p
        xcodebuild -showsdks

    - name: Install MAUI workload
      run: |
        dotnet workload install maui --skip-manifest-update
        dotnet workload list

    - name: Restore
      run: |
        CS_PROJ=$(find . -name "*.csproj" -type f | head -1)
        if [ -z "$CS_PROJ" ]; then
          echo "‚ùå No csproj found"
          exit 1
        fi
        dotnet restore "$CS_PROJ"

    - name: Build unsigned IPA (iOS 16+, net9.0-ios)
      run: |
        CS_PROJ=$(find . -name "*.csproj" -type f | head -1)

        dotnet publish "$CS_PROJ" \
          -c Release \
          -f net9.0-ios \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=true \
          -p:EnableCodeSigning=false \
          -p:SupportedOSPlatformVersion=16.0 \
          -p:TargetPlatformMinVersion=16.0 \
          -p:MtouchLink=SdkOnly \
          -p:_SdkVersion=17.5

    - name: Verify IPA output
      run: |
        echo "=== IPA files ==="
        find bin/Release/net9.0-ios/ios-arm64 -name "*.ipa" -type f || exit 1

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-sideloadly
        path: |
          bin/Release/net9.0-ios/ios-arm64/*.ipa
        retention-days: 7
