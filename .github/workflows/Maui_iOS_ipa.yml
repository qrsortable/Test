name: MAUI iOS IPA Build (Sideloadly Compatible)
on:
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.100'
  PROJECT_PATH: 'MyMauiAppIos'
  TARGET_FRAMEWORK: 'net9.0-ios'
  CONFIGURATION: 'Release'

jobs:
  build-ios:
    name: ðŸŽ Build iOS IPA for Sideloadly
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: âš™ï¸ Set Xcode version
        run: |
          # Use 16.1 as it is the most stable target for .NET 9
          sudo xcode-select -s /Applications/Xcode_16.1.app
          xcodebuild -version

      - name: ðŸ”· Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: ðŸ“¦ Install MAUI workloads
        run: |
          dotnet workload install maui-ios
      
      - name: ðŸ” Find and Patch Project File
        id: find_csproj
        run: |
          CSPROJ_FILE=$(find ${{ env.PROJECT_PATH }} -maxdepth 1 -name "*.csproj" | head -n 1)
          CSPROJ_NAME=$(basename "$CSPROJ_FILE")
          APP_NAME="${CSPROJ_NAME%.csproj}"
          
          echo "csproj_name=$CSPROJ_NAME" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

          # ðŸ›  THE FIX: Inject the bypass properties directly into the .csproj
          # This overrides the "Xcode 26.0" hallucination error at the root level.
          sed -i '' '/<\/Project>/i \
          <PropertyGroup><ValidateXcodeVersion>false</ValidateXcodeVersion><SkipValidateXcodeVersion>true</SkipXcodeVersion></PropertyGroup>' "${{ env.PROJECT_PATH }}/$CSPROJ_NAME"
          
          echo "âœ… Patched $CSPROJ_NAME to skip Xcode validation."

      - name: ðŸ“¥ Restore NuGet packages
        run: |
          dotnet restore ${{ steps.find_csproj.outputs.csproj_name }} \
            -p:TargetFrameworks=net9.0-ios
        working-directory: ${{ env.PROJECT_PATH }}
      
      - name: ðŸ”¨ Build iOS app
        run: |
          dotnet publish ${{ steps.find_csproj.outputs.csproj_name }} \
            -f:net9.0-ios \
            -c:Release \
            -p:TargetFrameworks=net9.0-ios \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:BuildIpa=true \
            -p:ArchiveOnBuild=true \
            -p:EnableCodeSigning=false \
            -p:PublishTrimmed=true \
            -p:MtouchLink=SdkOnly \
            -p:MtouchNoFastDev=true \
            -p:MtouchExtraArgs="--ignore-xcode-version" \
            --verbosity normal
        working-directory: ${{ env.PROJECT_PATH }}
        env:
          MD_APPLE_SDK_ROOT: /Applications/Xcode_16.1.app

      - name: âœ… Verify .app bundle
        id: verify_app
        run: |
          BUILD_PATH="${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}/ios-arm64"
          APP_PATH=$(find "$BUILD_PATH" -name "${{ steps.find_csproj.outputs.app_name }}.app" -type d | head -n 1)
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          
          # Fix executable permissions for Sideloadly
          EXEC_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$APP_PATH/Info.plist")
          chmod +x "$APP_PATH/$EXEC_NAME"

      - name: ðŸ“¦ Package IPA for Sideloadly
        run: |
          APP_PATH="${{ steps.verify_app.outputs.app_path }}"
          IPA_DIR="${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{
