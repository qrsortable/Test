name: MAUI iOS IPA Build (Sideloadly Compatible)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '**.cs'
      - '**.csproj'
      - '**.xaml'
      - '.github/workflows/**'

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'MyMauiAppIos'
  TARGET_FRAMEWORK: 'net9.0-ios'
  CONFIGURATION: 'Release'
  APP_NAME: 'MyMauiAppIos'

jobs:
  build-ios:
    name: ğŸ Build iOS IPA for Sideloadly
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      # ============================================
      # STEP 1: Checkout Repository
      # ============================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ============================================
      # STEP 2: Setup Xcode
      # ============================================
      - name: ğŸ”§ List available Xcode versions
        run: |
          echo "ğŸ“‹ Available Xcode versions:"
          ls /Applications | grep Xcode
      
      - name: âš™ï¸ Set Xcode version
        run: |
          echo "ğŸ” Selecting appropriate Xcode version..."
          
          if [ -d "/Applications/Xcode_15.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.2.app
            echo "âœ… Selected Xcode 15.2"
          elif [ -d "/Applications/Xcode_15.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.1.app
            echo "âœ… Selected Xcode 15.1"
          elif [ -d "/Applications/Xcode_15.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.0.app
            echo "âœ… Selected Xcode 15.0"
          elif [ -d "/Applications/Xcode_14.3.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_14.3.1.app
            echo "âœ… Selected Xcode 14.3.1"
          elif [ -d "/Applications/Xcode_14.3.app" ]; then
            sudo xcode-select -s /Applications/Xcode_14.3.app
            echo "âœ… Selected Xcode 14.3"
          else
            echo "âœ… Using default Xcode"
          fi
          
          echo ""
          echo "ğŸ“ Selected Xcode path:"
          xcode-select -p
          echo ""
          echo "â„¹ï¸ Xcode version:"
          xcodebuild -version
      
      # ============================================
      # STEP 3: Setup .NET
      # ============================================
      - name: ğŸ”· Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: â„¹ï¸ Display .NET info
        run: dotnet --info
      
      # ============================================
      # STEP 4: Cache NuGet Packages
      # ============================================
      - name: ğŸ’¾ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/Library/Caches/NuGet
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      # ============================================
      # STEP 5: Create Entitlements.plist
      # ============================================
      - name: ğŸ“ Create Entitlements.plist
        run: |
          echo "ğŸ“ Creating iOS entitlements file..."
          
          # Create directory if it doesn't exist
          mkdir -p ${{ env.PROJECT_PATH }}/Platforms/iOS
          
          # Create Entitlements.plist
          cat > ${{ env.PROJECT_PATH }}/Platforms/iOS/Entitlements.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <!-- Keychain Sharing - REQUIRED for MAUI SecureStorage and Preferences -->
              <key>keychain-access-groups</key>
              <array>
                  <string>$(AppIdentifierPrefix)com.companyname.mymauiappios</string>
              </array>
              
              <!-- Get Task Allow - Required for debugging and sideloading -->
              <key>get-task-allow</key>
              <true/>
              
              <!-- Network Client - Required for network operations -->
              <key>com.apple.security.network.client</key>
              <true/>
              
              <!-- If using specific features, uncomment as needed -->
              
              <!-- Push Notifications -->
              <!--
              <key>aps-environment</key>
              <string>development</string>
              -->
              
              <!-- Background Modes -->
              <!--
              <key>UIBackgroundModes</key>
              <array>
                  <string>fetch</string>
                  <string>remote-notification</string>
              </array>
              -->
              
              <!-- iCloud -->
              <!--
              <key>com.apple.developer.icloud-container-identifiers</key>
              <array>
                  <string>iCloud.$(CFBundleIdentifier)</string>
              </array>
              <key>com.apple.developer.ubiquity-kvstore-identifier</key>
              <string>$(TeamIdentifierPrefix)$(CFBundleIdentifier)</string>
              -->
          </dict>
          </plist>
          EOF
          
          echo ""
          echo "âœ… Entitlements.plist created successfully!"
          echo ""
          echo "ğŸ“„ Content:"
          cat ${{ env.PROJECT_PATH }}/Platforms/iOS/Entitlements.plist
      
      # ============================================
      # STEP 6: Install MAUI Workloads
      # ============================================
      - name: ğŸ“¦ Install MAUI workloads
        run: |
          echo "ğŸ“¦ Installing .NET MAUI workloads..."
          
          cd ${{ env.PROJECT_PATH }}
          
          # Install MAUI iOS workload
          dotnet workload install maui-ios --skip-manifest-update
          
          echo ""
          echo "âœ… Workload installation complete!"
          echo ""
          echo "ğŸ“‹ Installed workloads:"
          dotnet workload list
      
      # ============================================
      # STEP 7: Find Project File
      # ============================================
      - name: ğŸ” Find .csproj file
        id: find_csproj
        run: |
          echo "ğŸ” Searching for .csproj file in ${{ env.PROJECT_PATH }}..."
          
          CSPROJ_FILE=$(find ${{ env.PROJECT_PATH }} -maxdepth 1 -name "*.csproj" | head -n 1)
          
          if [ -z "$CSPROJ_FILE" ]; then
            echo "âŒ Error: No .csproj file found in ${{ env.PROJECT_PATH }}"
            echo "ğŸ“ Directory contents:"
            ls -la ${{ env.PROJECT_PATH }}
            exit 1
          fi
          
          CSPROJ_NAME=$(basename "$CSPROJ_FILE")
          APP_NAME="${CSPROJ_NAME%.csproj}"
          
          echo "csproj_name=$CSPROJ_NAME" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Found project file: $CSPROJ_NAME"
          echo "ğŸ“± App name: $APP_NAME"
      
      # ============================================
      # STEP 8: Restore NuGet Packages
      # ============================================
      - name: ğŸ“¥ Restore NuGet packages
        run: |
          echo "ğŸ“¥ Restoring NuGet packages..."
          
          dotnet restore ${{ steps.find_csproj.outputs.csproj_name }} \
            --verbosity normal
          
          echo "âœ… Restore completed!"
        working-directory: ${{ env.PROJECT_PATH }}
      
      # ============================================
      # STEP 9: Build iOS Application
      # ============================================
      - name: ğŸ”¨ Build iOS app
        run: |
          echo "ğŸ”¨ Building iOS application..."
          echo "ğŸ“± App: ${{ steps.find_csproj.outputs.app_name }}"
          echo "ğŸ¯ Framework: ${{ env.TARGET_FRAMEWORK }}"
          echo "âš™ï¸ Configuration: ${{ env.CONFIGURATION }}"
          echo ""
          
          dotnet publish ${{ steps.find_csproj.outputs.csproj_name }} \
            -f:${{ env.TARGET_FRAMEWORK }} \
            -c:${{ env.CONFIGURATION }} \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:CodesignKey="-" \
            -p:CodesignProvision="" \
            -p:CodesignEntitlements="Platforms/iOS/Entitlements.plist" \
            -p:EnableCodeSigning=false \
            -p:_DevelopmentTeam="" \
            -p:BuildIpa=false \
            -p:MtouchLink=SdkOnly \
            -p:UseInterpreter=false \
            -p:MtouchNoFastDev=true \
            -p:SupportedOSPlatformVersion=15.0 \
            -p:TargetPlatformMinVersion=15.0 \
            -p:PublishTrimmed=true \
            -p:TrimMode=partial \
            -p:OptimizePNGs=false \
            -p:UseAccessorizer=false \
            -p:ActoolComputeOnlySupportedPlatforms=true \
            --verbosity normal
          
          echo ""
          echo "âœ… Build completed successfully!"
        working-directory: ${{ env.PROJECT_PATH }}
      
      # ============================================
      # STEP 10: List Build Output
      # ============================================
      - name: ğŸ“‚ List build output
        run: |
          echo "ğŸ“‚ Analyzing build output structure..."
          echo ""
          
          BUILD_PATH="${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}"
          
          echo "ğŸ” Searching for .app bundles in: $BUILD_PATH"
          echo ""
          
          APP_BUNDLES=$(find "$BUILD_PATH" -type d -name "*.app" 2>/dev/null || echo "")
          
          if [ -n "$APP_BUNDLES" ]; then
            echo "âœ… Found .app bundle(s):"
            echo "$APP_BUNDLES"
          else
            echo "âš ï¸ No .app bundles found"
          fi
          
          echo ""
          echo "ğŸ“ Full directory structure:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          if [ -d "$BUILD_PATH/ios-arm64" ]; then
            ls -lah "$BUILD_PATH/ios-arm64/" || true
          else
            ls -lah "$BUILD_PATH/" || true
          fi
      
      # ============================================
      # STEP 11: Verify .app Bundle
      # ============================================
      - name: âœ… Verify .app bundle
        id: verify_app
        run: |
          echo "ğŸ” Verifying .app bundle structure..."
          
          BUILD_PATH="${{ env.PROJECT_PATH }}/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}"
          
          # Search for .app bundle
          APP_PATH=$(find "$BUILD_PATH" -name "${{ steps.find_csproj.outputs.app_name }}.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Error: Could not find ${{ steps.find_csproj.outputs.app_name }}.app"
            echo ""
            echo "ğŸ“‚ Available .app bundles:"
            find "$BUILD_PATH" -name "*.app" -type d || echo "None found"
            exit 1
          fi
          
          echo "âœ… Found app bundle: $APP_PATH"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          
          # Verify Info.plist
          if [ ! -f "$APP_PATH/Info.plist" ]; then
            echo "âŒ Error: Invalid app bundle - missing Info.plist"
            exit 1
          fi
          
          echo "âœ… Info.plist exists"
          
          # Get bundle info
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$APP_PATH/Info.plist" 2>/dev/null || echo "Unknown")
          BUNDLE_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleName" "$APP_PATH/Info.plist" 2>/dev/null || echo "Unknown")
          BUNDLE_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$APP_PATH/Info.plist" 2>/dev/null || echo "Unknown")
          EXEC_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$APP_PATH/Info.plist" 2>/dev/null || echo "Unknown")
          MIN_IOS=$(/usr/libexec/PlistBuddy -c "Print :MinimumOSVersion" "$APP_PATH/Info.plist" 2>/dev/null || echo "Unknown")
          
          echo ""
          echo "ğŸ“± App Bundle Information:"
          echo "   Bundle ID: $BUNDLE_ID"
          echo "   Bundle Name: $BUNDLE_NAME"
          echo "   Version: $BUNDLE_VERSION"
          echo "   Executable: $EXEC_NAME"
          echo "   Min iOS: $MIN_IOS"
          
          # Verify executable exists
          if [ ! -f "$APP_PATH/$EXEC_NAME" ]; then
            echo "âŒ Error: Executable not found: $EXEC_NAME"
            echo ""
            echo "ğŸ“‚ App bundle contents:"
            ls -la "$APP_PATH"
            exit 1
          fi
          
          echo "âœ… Executable exists and is valid"
          
          # Check file permissions
          if [ ! -x "$APP_PATH/$EXEC_NAME" ]; then
            echo "âš ï¸ Warning: Executable is not marked as executable, fixing..."
            chmod +x "$APP_PATH/$EXEC_NAME"
            echo "âœ… Fixed executable permissions"
          fi
          
          # Check for Entitlements.plist in bundle
          if [ -f "$APP_PATH/Entitlements.plist" ]; then
            echo "âœ… Entitlements.plist found in bundle"
          else
            echo "âš ï¸ Entitlements.plist not found in bundle (this is OK for unsigned builds)"
          fi
          
          echo ""
          echo "âœ… App bundle verification complete!"
      
      # ============================================
      # STEP 12: Package IPA
      # ============================================
      - name: ğŸ“¦ Package IPA for Sideloadly
        id: package_ipa
        run: |
          echo "ğŸ“¦ Creating IPA package..."
          
          APP_PATH="${{ steps.verify_app.outputs.app_path }}"
          IPA_NAME="${{ steps.find_csproj.outputs.app_name }}-Sideloadly"
          
          # Create temporary working directory
          WORK_DIR=$(mktemp -d)
          echo "ğŸ“ Working directory: $WORK_DIR"
          
          # Create Payload directory
          mkdir -p "$WORK_DIR/Payload"
          
          echo "ğŸ“‹ Copying app bundle..."
          # Copy app bundle preserving all attributes, permissions, and symlinks
          cp -Rp "$APP_PATH" "$WORK_DIR/Payload/"
          
          # Verify copy
          if [ ! -d "$WORK_DIR/Payload/${{ steps.find_csproj.outputs.app_name }}.app" ]; then
            echo "âŒ Error: Failed to copy app bundle"
            exit 1
          fi
          
          echo "âœ… App bundle copied successfully"
          
          # Create IPA (zip archive)
          echo "ğŸ—œï¸ Creating IPA archive..."
          cd "$WORK_DIR"
          zip -qry "$IPA_NAME.ipa" Payload
          
          if [ ! -f "$IPA_NAME.ipa" ]; then
            echo "âŒ Error: Failed to create IPA"
            exit 1
          fi
          
          echo "âœ… IPA archive created"
          
          # Move to workspace
          IPA_PATH="${{ github.workspace }}/$IPA_NAME.ipa"
          mv "$IPA_NAME.ipa" "$IPA_PATH"
          
          # Get file size
          IPA_SIZE=$(du -h "$IPA_PATH" | cut -f1)
          IPA_SIZE_BYTES=$(stat -f%z "$IPA_PATH" 2>/dev/null || stat -c%s "$IPA_PATH" 2>/dev/null)
          
          echo ""
          echo "âœ… IPA created successfully!"
          echo "   ğŸ“ Path: $IPA_PATH"
          echo "   ğŸ“Š Size: $IPA_SIZE ($IPA_SIZE_BYTES bytes)"
          
          # Set outputs
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
          echo "ipa_name=$IPA_NAME.ipa" >> $GITHUB_OUTPUT
          echo "ipa_size=$IPA_SIZE" >> $GITHUB_OUTPUT
          
          # Cleanup temp directory
          rm -rf "$WORK_DIR"
          echo "ğŸ§¹ Cleaned up temporary files"
      
      # ============================================
      # STEP 13: Verify IPA Structure
      # ============================================
      - name: ğŸ” Verify IPA structure
        run: |
          IPA_FILE="${{ steps.package_ipa.outputs.ipa_path }}"
          
          echo "ğŸ” Verifying IPA structure..."
          echo "ğŸ“„ File: $IPA_FILE"
          echo ""
          
          # Check if IPA exists
          if [ ! -f "$IPA_FILE" ]; then
            echo "âŒ Error: IPA file not found!"
            exit 1
          fi
          
          # List IPA contents (first 50 lines)
          echo "ğŸ“‹ IPA Contents (top 50 entries):"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          unzip -l "$IPA_FILE" | head -50
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          
          # Extract and verify Info.plist
          echo "ğŸ“± Extracting Info.plist for verification..."
          TEMP_DIR=$(mktemp -d)
          unzip -q "$IPA_FILE" "Payload/*.app/Info.plist" -d "$TEMP_DIR" 2>/dev/null || true
          
          INFO_PLIST=$(find "$TEMP_DIR/Payload" -name "Info.plist" | head -n 1)
          
          if [ -f "$INFO_PLIST" ]; then
            echo "âœ… Info.plist verified:"
            echo ""
            BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFO_PLIST" 2>/dev/null || echo "Unknown")
            BUNDLE_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleName" "$INFO_PLIST" 2>/dev/null || echo "Unknown")
            BUNDLE_DISPLAY=$(/usr/libexec/PlistBuddy -c "Print :CFBundleDisplayName" "$INFO_PLIST" 2>/dev/null || echo "$BUNDLE_NAME")
            VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$INFO_PLIST" 2>/dev/null || echo "Unknown")
            BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$INFO_PLIST" 2>/dev/null || echo "Unknown")
            MIN_IOS=$(/usr/libexec/PlistBuddy -c "Print :MinimumOSVersion" "$INFO_PLIST" 2>/dev/null || echo "Unknown")
            
            echo "   Bundle ID: $BUNDLE_ID"
            echo "   Bundle Name: $BUNDLE_NAME"
            echo "   Display Name: $BUNDLE_DISPLAY"
            echo "   Version: $VERSION (Build $BUILD)"
            echo "   Minimum iOS: $MIN_IOS"
            echo ""
            
            # Verify Payload structure
            PAYLOAD_CONTENTS=$(unzip -l "$IPA_FILE" | grep "Payload/" | wc -l)
            echo "âœ… Payload contains $PAYLOAD_CONTENTS items"
            
            # Check for common required files
            echo ""
            echo "ğŸ” Checking for required files:"
            
            if unzip -l "$IPA_FILE" | grep -q "Payload/.*\.app/Info.plist"; then
              echo "   âœ… Info.plist"
            else
              echo "   âŒ Info.plist missing"
            fi
            
            if unzip -l "$IPA_FILE" | grep -q "Payload/.*\.app/$BUNDLE_NAME"; then
              echo "   âœ… Main executable"
            else
              echo "   âš ï¸ Main executable check inconclusive"
            fi
            
            if unzip -l "$IPA_FILE" | grep -q "Payload/.*\.app/.*\.dll"; then
              echo "   âœ… .NET assemblies"
            else
              echo "   âš ï¸ No .NET assemblies found (unexpected for MAUI)"
            fi
            
          else
            echo "âš ï¸ Warning: Could not verify Info.plist"
          fi
          
          # Cleanup
          rm -rf "$TEMP_DIR"
          
          echo ""
          echo "âœ… IPA verification complete!"
      
      # ============================================
      # STEP 14: Generate Installation Instructions
      # ============================================
      - name: ğŸ“ Generate installation instructions
        run: |
          echo "ğŸ“ Creating installation instructions..."
          
          cat > ${{ github.workspace }}/SIDELOAD_INSTRUCTIONS.md << 'INSTRUCTIONS_EOF'
          # ğŸ“± Sideloading Instructions for ${{ steps.find_csproj.outputs.app_name }}
          
          ## âš™ï¸ Prerequisites
          
          1. **Download Sideloadly**
             - Visit: https://sideloadly.io/
             - Download for your OS (Windows/Mac/Linux)
             - Install and launch the application
          
          2. **Apple ID**
             - Free Apple ID (expires every 7 days)
             - OR Paid Developer Account (expires yearly)
          
          3. **iOS Device**
             - iPhone or iPad running iOS 15.0 or later
             - Lightning or USB-C cable
          
          ---
          
          ## ğŸ“¦ Installation Steps
          
          ### Step 1: Connect Your Device
          
          1. Connect your iPhone/iPad to your computer via USB cable
          2. Unlock your device
          3. Trust the computer if prompted:
             - Tap "Trust" on the device popup
             - Enter your device passcode
          
          ### Step 2: Launch Sideloadly
          
          1. Open Sideloadly application
          2. Your device should appear in the device dropdown
          3. If device not detected:
             - On Mac: Make sure you have Xcode Command Line Tools installed
             - On Windows: Install iTunes (non-Microsoft Store version)
             - Restart Sideloadly
          
          ### Step 3: Load the IPA
          
          1. Drag and drop `${{ steps.find_csproj.outputs.app_name }}-Sideloadly.ipa` into Sideloadly
          2. OR click the IPA icon and browse to select the file
          
          ### Step 4: Configure Settings
          
          **IMPORTANT - Change Bundle ID:**
          
          ```
          Original: com.companyname.mymauiappios
          Change to: com.yourname.${{ steps.find_csproj.outputs.app_name }}.custom
          ```
          
          âš ï¸ **You MUST change the Bundle ID or installation may fail!**
          
          **Apple ID:**
          - Enter your Apple ID email address
          
          **Advanced Options (click the wrench icon):**
          - âœ… **Enable: Remove App Extensions** (if app crashes after install)
          - âœ… **Enable: Remove UISupportedDevices limitation**
          - âœ… **Enable: Force installation** (if previous attempts failed)
          - â„¹ï¸ Keep other settings at default
          
          ### Step 5: Start Installation
          
          1. Click the **"Start"** button
          2. Enter your Apple ID password when prompted
          3. If you have 2FA enabled:
             - Check your trusted device for the code
             - Enter the 6-digit verification code
          4. Wait for installation to complete (2-5 minutes)
             - Progress bar will show the status
             - Don't disconnect your device during installation
          
          ### Step 6: Trust the Developer Certificate
          
          1. On your iOS device, go to:
             ```
             Settings â†’ General â†’ VPN & Device Management
             ```
          
          2. Under "Developer App", find your Apple ID
          
          3. Tap on your Apple ID profile
          
          4. Tap **"Trust [Your Apple ID]"**
          
          5. Tap **"Trust"** again to confirm
          
          ### Step 7: Launch the App
          
          1. Return to your home screen
          2. Find the ${{ steps.find_csproj.outputs.app_name }} icon
          3. Tap to launch
          4. The app should now open without crashing!
          
          ---
          
          ## ğŸ”§ Troubleshooting
          
          ### âŒ App Crashes on Launch
          
          **Solution 1: Enable "Remove App Extensions"**
          - Delete the app from your device
          - In Sideloadly, click Advanced Options (wrench icon)
          - Enable "Remove App Extensions"
          - Reinstall the app
          
          **Solution 2: Force Installation**
          - In Advanced Options, enable "Force installation"
          - Change Bundle ID to something completely different
          - Reinstall
          
          **Solution 3: Check iOS Version**
          - This app requires iOS 15.0 or later
          - Go to Settings â†’ General â†’ About â†’ Software Version
          - Update iOS if needed
          
          ### âš ï¸ "Untrusted Developer" Error
          
          - You forgot to trust the developer certificate
          - Follow Step 6 above
          
          ### ğŸš« Installation Failed
          
          **Error: "Developer disk image not found"**
          - Update Sideloadly to the latest version
          - Update Xcode (Mac) or iTunes (Windows)
          
          **Error: "Failed to verify code signature"**
          - Change the Bundle ID to something unique
          - Try a different Apple ID
          
          **Error: "Maximum number of apps reached"**
          - Free Apple ID: Limited to 3 apps
          - Delete an existing sideloaded app
          - OR use a paid Developer Account
          
          **Error: "This Apple ID has not yet been used"**
          - Log into https://appleid.apple.com
          - Complete the setup process
          - Try again
          
          ### â° App Expired (After 7 Days)
          
          **With Free Apple ID:**
          - Apps expire after 7 days
          - You must re-sideload every week
          
          **Solutions:**
          1. Manual re-sideload every 7 days
          2. Use Sideloadly's auto-refresh feature:
             - Install Sideloadly Daemon on your computer
             - Keep computer on and device on WiFi
             - Apps auto-refresh in background
          3. Purchase Apple Developer Account ($99/year):
             - Apps expire after 1 year instead
          
          ### ğŸ”Œ Device Not Detected
          
          **Mac:**
          ```bash
          # Install Xcode Command Line Tools
          xcode-select --install
          ```
          
          **Windows:**
          - Install iTunes from Apple (NOT Microsoft Store version)
          - Download from: https://www.apple.com/itunes/download/win64
          - Restart computer after installation
          
          **Linux:**
          - Install libimobiledevice
          - Follow Sideloadly documentation for Linux setup
          
          ### ğŸ“± App Features Not Working
          
          **If SecureStorage/Preferences don't work:**
          - This shouldn't happen with this build
          - Report the issue with details
          
          **If network features don't work:**
          - Check iOS Settings â†’ Privacy â†’ Local Network
          - Enable for ${{ steps.find_csproj.outputs.app_name }}
          
          ---
          
          ## ğŸ“Š App Information
          
          - **App Name:** ${{ steps.find_csproj.outputs.app_name }}
          - **Bundle ID:** com.companyname.mymauiappios (change this!)
          - **Minimum iOS:** 15.0
          - **IPA Size:** ${{ steps.package_ipa.outputs.ipa_size }}
          - **Build Type:** Unsigned (for sideloading)
          
          ---
          
          ## ğŸ†˜ Still Having Issues?
          
          1. **Check Sideloadly logs:**
             - View â†’ Show Logs
             - Look for specific error messages
          
          2. **Try these steps in order:**
             ```
             1. Restart Sideloadly
             2. Restart your device
             3. Use a different USB cable
             4. Try a different USB port
             5. Use a different Apple ID
             6. Update Sideloadly to latest version
             ```
          
          3. **Get device logs (Mac only):**
             ```bash
             # After app crashes, run:
             idevicecrashreport -e -o ~/Desktop/crash-logs/
             ```
          
          4. **Common solutions checklist:**
             - [ ] Changed Bundle ID to unique value
             - [ ] Trusted developer certificate in Settings
             - [ ] iOS version is 15.0 or higher
             - [ ] USB cable is working properly
             - [ ] Apple ID is valid and verified
             - [ ] Not exceeding 3 app limit (free account)
          
          ---
          
          ## ğŸ’¡ Pro Tips
          
          1. **Always change the Bundle ID** - Use your name or GitHub username
          2. **Keep the IPA file** - You'll need it to reinstall every 7 days
          3. **Set a calendar reminder** - Don't let your apps expire
          4. **Use WiFi refresh** - Install Sideloadly Daemon for auto-refresh
          5. **Keep Sideloadly updated** - New iOS versions need new Sideloadly updates
          6. **Backup your data** - Apps can lose data when reinstalling
          
          ---
          
          ## ğŸ”— Useful Links
          
          - Sideloadly: https://sideloadly.io/
          - Sideloadly FAQ: https://sideloadly.io/#faq
          - Apple ID: https://appleid.apple.com/
          - iOS Developer Program: https://developer.apple.com/programs/
          
          ---
          
          **Built with â¤ï¸ using .NET MAUI 9**
          INSTRUCTIONS_EOF
          
          echo "âœ… Installation instructions created!"
          echo "ğŸ“„ File: SIDELOAD_INSTRUCTIONS.md"
      
      # ============================================
      # STEP 15: Create Quick Start Guide
      # ============================================
      - name: ğŸ“„ Create quick start guide
        run: |
          cat > ${{ github.workspace }}/QUICK_START.txt << 'QUICKSTART_EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    QUICK START GUIDE                           â•‘
          â•‘            ${{ steps.find_csproj.outputs.app_name }}           â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          STEP 1: Download Sideloadly from https://sideloadly.io/
          
          STEP 2: Connect your iPhone/iPad via USB cable
          
          STEP 3: Open Sideloadly and drag the .ipa file into it
          
          STEP 4: IMPORTANT - Change Bundle ID to something unique:
                  com.yourname.mymauiappios.custom
          
          STEP 5: Enter your Apple ID and click Start
          
          STEP 6: Trust the certificate:
                  Settings â†’ General â†’ VPN & Device Management
          
          STEP 7: Launch the app from your home screen!
          
          âš ï¸  TROUBLESHOOTING:
          
          â€¢ App crashes? Enable "Remove App Extensions" in Sideloadly
          â€¢ Not trusted? Go to Settings and trust your Apple ID
          â€¢ Won't install? Change the Bundle ID
          â€¢ Need more help? Read SIDELOAD_INSTRUCTIONS.md
          
          â„¹ï¸  NOTES:
          
          â€¢ Free Apple ID: App expires every 7 days
          â€¢ Minimum iOS: 15.0
          â€¢ Max apps: 3 (free account)
          
          Full instructions: See SIDELOAD_INSTRUCTIONS.md
          
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          QUICKSTART_EOF
          
          echo "âœ… Quick start guide created!"
      
      # ============================================
      # STEP 16: Upload IPA Artifact
      # ============================================
      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.find_csproj.outputs.app_name }}-iOS-Sideloadly
          path: |
            ${{ steps.package_ipa.outputs.ipa_path }}
            ${{ github.workspace }}/SIDELOAD_INSTRUCTIONS.md
            ${{ github.workspace }}/QUICK_START.txt
          if-no-files-found: error
          retention-days: 90
      
      # ============================================
      # STEP 17: Generate Build Summary
      # ============================================
      - name: ğŸ“Š Generate build summary
        if: always()
        run: |
          echo "# ğŸ‰ iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "${{ steps.package_ipa.outputs.ipa_path }}" ]; then
            echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“¦ Artifact Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **App Name** | ${{ steps.find_csproj.outputs.app_name }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **IPA File** | ${{ steps.package_ipa.outputs.ipa_name }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **File Size** | ${{ steps.package_ipa.outputs.ipa_size }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Target iOS** | 15.0+ |" >> $GITHUB_STEP_SUMMARY
            echo "| **Architecture** | arm64 |" >> $GITHUB_STEP_SUMMARY
            echo "| **Framework** | ${{ env.TARGET_FRAMEWORK }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸ“¥ Download Instructions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to the **Actions** tab" >> $GITHUB_STEP_SUMMARY
            echo "2. Click on this workflow run" >> $GITHUB_STEP_SUMMARY
            echo "3. Scroll to **Artifacts** section" >> $GITHUB_STEP_SUMMARY
            echo "4. Download **${{ steps.find_csproj.outputs.app_name }}-iOS-Sideloadly**" >> $GITHUB_STEP_SUMMARY
            echo "5. Extract the ZIP file" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸš€ Installation Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Download [Sideloadly](https://sideloadly.io/)" >> $GITHUB_STEP_SUMMARY
            echo "2. Connect iPhone/iPad via USB" >> $GITHUB_STEP_SUMMARY
            echo "3. Open Sideloadly and load the IPA file" >> $GITHUB_STEP_SUMMARY
            echo "4. **âš ï¸ IMPORTANT:** Change Bundle ID to something unique" >> $GITHUB_STEP_SUMMARY
            echo "   - Example: \`com.yourname.${{ steps.find_csproj.outputs.app_name }}.custom\`" >> $GITHUB_STEP_SUMMARY
            echo "5. Enter Apple ID and click Start" >> $GITHUB_STEP_SUMMARY
            echo "6. Trust certificate in Settings â†’ General â†’ VPN & Device Management" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸ“– Documentation Included" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **SIDELOAD_INSTRUCTIONS.md** - Detailed installation guide" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **QUICK_START.txt** - Quick reference guide" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### âš ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Free Apple ID: Apps expire every **7 days**" >> $GITHUB_STEP_SUMMARY
            echo "- Paid Developer: Apps expire every **1 year**" >> $GITHUB_STEP_SUMMARY
            echo "- Maximum apps: **3** (free account)" >> $GITHUB_STEP_SUMMARY
            echo "- Minimum iOS version: **15.0**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸ†˜ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**App crashes on launch?**" >> $GITHUB_STEP_SUMMARY
            echo "- Enable \"Remove App Extensions\" in Sideloadly Advanced Options" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Installation fails?**" >> $GITHUB_STEP_SUMMARY
            echo "- Make sure you changed the Bundle ID" >> $GITHUB_STEP_SUMMARY
            echo "- Try a different Apple ID" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Need detailed help?**" >> $GITHUB_STEP_SUMMARY
            echo "- Read the included SIDELOAD_INSTRUCTIONS.md file" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The IPA file was not created. Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Built with .NET MAUI ${{ env.DOTNET_VERSION }} on $(date)*" >> $GITHUB_STEP_SUMMARY
      
      # ============================================
      # STEP 18: Final Status
      # ============================================
      - name: âœ… Build complete
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                â•‘"
          echo "â•‘                  âœ… BUILD COMPLETED SUCCESSFULLY! âœ…            â•‘"
          echo "â•‘                                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± App Name: ${{ steps.find_csproj.outputs.app_name }}"
          echo "ğŸ“¦ IPA File: ${{ steps.package_ipa.outputs.ipa_name }}"
          echo "ğŸ“Š File Size: ${{ steps.package_ipa.outputs.ipa_size }}"
          echo ""
          echo "ğŸ“¥ Download the artifact from the Actions tab"
          echo "ğŸ“– Read SIDELOAD_INSTRUCTIONS.md for installation help"
          echo ""
          echo "ğŸ¯ Next Steps:"
          echo "   1. Download artifact from Actions â†’ Artifacts"
          echo "   2. Extract the ZIP file"
          echo "   3. Install using Sideloadly"
          echo "   4. Don't forget to change the Bundle ID!"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
